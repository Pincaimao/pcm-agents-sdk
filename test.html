<extend name="Base:base" />
<block name="title">
  <title>三甲进修+医美培训-医聘猫</title>
</block>
<block name="keywords">
  <meta name="keywords" content="三甲进修+医美培训-医聘猫" />
</block>
<block name="description">
  <meta name="description" content="三甲进修+医美培训-医聘猫" />
</block>
<block name="viewport">
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
</block>
<block name="other_script_top">
  <link
    rel="stylesheet"
    type="text/css"
    href="/Public/Newhome/css/tailwindcss.css"
  />
  <script type="module" src="https://unpkg.com/pcm-agents"></script>
  <!-- 其他需要引入的脚本文件 -->
  <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      }
      .demo-controls {
        margin: 20px;
        padding: 20px;
        border: 1px solid #eee;
        border-radius: 8px;
      }
      button {
        padding: 8px 16px;
        background-color: #1890ff;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .status {
        margin: 10px 0;
        padding: 10px;
        border-radius: 4px;
      }
      .success {
        background-color: #f6ffed;
        border: 1px solid #b7eb8f;
        color: #52c41a;
      }
      .error {
        background-color: #fff2f0;
        border: 1px solid #ffccc7;
        color: #ff4d4f;
      }
      .device-check {
        margin-bottom: 15px;
      }
      .permission-info {
        margin-top: 10px;
        font-size: 14px;
        color: #666;
      }
    </style>
</block>
<block name="header"> </block>

<block name="maincontent">
  <div id="tailwindcss" style="display: flex; justify-content: center">
   <div class="demo-controls">
      <h2>组件演示</h2>
      
      <div class="email-input-section" style="margin-bottom: 20px;">
        <label for="user-email" style="display: block; margin-bottom: 8px;">请输入您的邮箱：</label>
        <input 
          type="email" 
          id="user-email" 
          placeholder="请输入邮箱地址"
          style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px; margin-bottom: 8px;"
        >
        <div id="email-error" style="color: #ff4d4f; font-size: 12px; display: none;">请输入有效的邮箱地址</div>
      </div>
      
      <div class="device-check">
        <button id="check-devices">检查设备权限</button>
        <div id="status-message" class="status" style="display: none;"></div>
        <div class="permission-info">
          需要检查您的摄像头和麦克风权限，以便在聊天过程中进行视频通话。
        </div>
      </div>
      
      <button id="open-chat" disabled>打开聊天</button>
    </div>

      <pcm-hr-chat-modal 
      bot-id="3022316191018882"
      id="pcm-chat-modal" 
      api-key="app-YXtEFC4fdga5QCCsANCbESGD"
      modal-title="劳动合同卫士" 
      icon="https://www.ylzhaopin.com/Public/Newhome/images/sidebar/tochat.png"
      conversation-id=""
      email="790002517@qq.com"
      fullscreen="true"
    ></pcm-hr-chat-modal>

  </div>
</block>
<block name="other_script_down">
  <script>
      document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM 已加载，正在设置事件监听器...');
        
        // 获取元素引用
        const chatModal = document.getElementById('pcm-chat-modal');
        const openChatButton = document.getElementById('open-chat');
        const checkDevicesButton = document.getElementById('check-devices');
        const statusMessage = document.getElementById('status-message');
        const emailInput = document.getElementById('user-email');
        const emailError = document.getElementById('email-error');
        
        // 邮箱验证函数
        function validateEmail(email) {
          const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
          return re.test(email);
        }
        
        // 邮箱输入事件处理
        emailInput.addEventListener('input', function() {
          const email = this.value.trim();
          if (validateEmail(email)) {
            emailError.style.display = 'none';
            chatModal.setAttribute('email', email);
            checkDevicesButton.disabled = false;
          } else {
            emailError.style.display = 'block';
            checkDevicesButton.disabled = true;
            openChatButton.disabled = true;
          }
        });

        // 初始状态设置
        checkDevicesButton.disabled = true;
        
        // 检查设备和权限
        let stream = null;
        
        checkDevicesButton.addEventListener('click', async function() {
          try {
            statusMessage.style.display = 'block';
            
            // 检查浏览器支持
            if (!navigator.mediaDevices) {
              showError('您的浏览器不支持媒体设备API，请使用现代浏览器如Chrome、Firefox等');
              return;
            }
            
            // 列出可用的媒体设备
            const devices = await navigator.mediaDevices.enumerateDevices();
            const hasCamera = devices.some(device => device.kind === 'videoinput');
            const hasMicrophone = devices.some(device => device.kind === 'audioinput');
            
            if (!hasCamera) {
              showError('未检测到摄像头设备');
              return;
            }
            
            if (!hasMicrophone) {
              showError('未检测到麦克风设备');
              return;
            }
            
            // 尝试获取媒体流
            stream = await navigator.mediaDevices.getUserMedia({
              video: true,
              audio: true
            });
            
            // 更新UI状态
            showSuccess('设备和权限检查通过，可以开始聊天');
            openChatButton.disabled = false;
            
          } catch (error) {
            console.error('获取媒体设备失败:', error);
            
            if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
              showError('权限被拒绝。请在浏览器设置中允许访问摄像头和麦克风。');
            } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
              showError('找不到摄像头或麦克风设备。');
            } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
              showError('无法访问摄像头或麦克风，可能被其他应用程序占用。');
            } else {
              showError(`发生错误: ${error.message}`);
            }
          }
        });
        
        // 辅助函数
        function showError(message) {
          statusMessage.textContent = message;
          statusMessage.className = 'status error';
        }
        
        function showSuccess(message) {
          statusMessage.textContent = message;
          statusMessage.className = 'status success';
        }
        
        if (chatModal) {
          chatModal.addEventListener('messageSent', function(event) {
            console.log('发送消息:', event.detail);
          });
          
          chatModal.addEventListener('modalClosed', function() {
            console.log('聊天窗口已关闭');
          });

          // 添加 streamComplete 事件监听
          chatModal.addEventListener('streamComplete', function(event) {
            console.log('流式响应完成:', event.detail);
            // 更新 conversation_id
            chatModal.setAttribute('conversation-id', event.detail.conversation_id);
          });

          // 添加 interviewComplete 事件监听
          chatModal.addEventListener('interviewComplete', function(event) {
            console.log('面试完成:', event.detail);
            chatModal.isOpen = false;
            alert('面试已完成，感谢您的参与！');
          });
        }

        // 打开聊天按钮事件监听
        if (openChatButton && chatModal) {
          openChatButton.addEventListener('click', function() {
            chatModal.isOpen = true;
             console.log('打开聊天');
            // 停止媒体流，因为已经不需要了
            if (stream) {
              stream.getTracks().forEach(track => track.stop());
              stream = null;
            }
          });
        }
        
        // 页面关闭时停止所有媒体流
        window.addEventListener('beforeunload', () => {
          if (stream) {
            stream.getTracks().forEach(track => track.stop());
          }
        });
      });
    </script>
</block>
<block name="footer"></block>
