<!DOCTYPE html>
<html dir="ltr" lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1.0,viewport-fit=cover">
  <title>Stencil Component Starter</title>

  <script type="module" src="/build/pcm-agents.esm.js"></script>
  <script nomodule src="/build/pcm-agents.js"></script>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
    }

    .demo-controls {
      margin: 20px;
      padding: 20px;
      border: 1px solid #eee;
      border-radius: 8px;
    }

    button {
      padding: 8px 16px;
      background-color: #1890ff;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-right: 10px;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .status {
      margin: 10px 0;
      padding: 10px;
      border-radius: 4px;
    }

    .success {
      background-color: #f6ffed;
      border: 1px solid #b7eb8f;
      color: #52c41a;
    }

    .error {
      background-color: #fff2f0;
      border: 1px solid #ffccc7;
      color: #ff4d4f;
    }

    .device-check {
      margin-bottom: 15px;
    }

    .permission-info {
      margin-top: 10px;
      font-size: 14px;
      color: #666;
    }
  </style>
</head>

<body>
  <div class="demo-controls">
    <h2>组件演示</h2>

    <div class="device-check">
      <button id="check-devices">检查设备权限</button>
      <div id="status-message" class="status" style="display: none;"></div>
      <div class="permission-info">
        需要检查您的摄像头和麦克风权限，以便在聊天过程中进行视频通话。
      </div>
    </div>

    <button id="open-chat">打开视频面试</button>
    <button id="open-hr-chat">打开金牌HR大赛</button>
  </div>

  <div class="demo-controls">
    <h2>模拟面试组件演示</h2>
    <button id="open-mnms-chat">打开模拟面试</button>
  </div>

  <div class="demo-controls">
    <h2>简历匹配组件演示</h2>
    <button id="open-jlpx-chat">打开简历匹配</button>
  </div>

  <div class="demo-controls">
    <h2>职业规划助手演示</h2>
    <button id="open-zygh-chat">打开职业规划助手</button>
  </div>

  <div class="demo-controls">
    <h2>面试出题大师演示</h2>
    <button id="open-mnct-chat">打开面试出题大师</button>
  </div>

  <!-- <my-component first="Stencil" middle="'Don't call me a framework'" last="JS"></my-component> -->


  <!-- 添加聊天模态框组件 -->
  <pcm-mnct-modal id="pcm-mnct-modal"
    modal-title="面试出题大师" 
    icon="https://pub.pincaimao.com/static/common/i_pcm_logo.png" 
    conversation-id=""
    fullscreen="false" 
    enable-voice="false" 
    interview-mode="text"
    default-query="请您提问">
    </pcm-mnct-modal>

  <pcm-mnms-modal id="pcm-mnms-modal"
    modal-title="模拟面试" 
    icon="https://pub.pincaimao.com/static/common/i_pcm_logo.png" 
    conversation-id=""
    fullscreen="false" 
    enable-voice="false" 
    interview-mode="text"
    default-query="请您提问">
  </pcm-mnms-modal>

  <pcm-jlpp-modal id="pcm-jlpp-modal"
    modal-title="简历匹配助手" icon="https://pub.pincaimao.com/static/common/i_pcm_logo.png" conversation-id=""
    fullscreen="false"  enable-voice="false" interview-mode="text"
    default-query="请您提问"></pcm-jlpp-modal>

  <pcm-zygh-modal id="pcm-zygh-modal"
    modal-title="职业规划助手" icon="https://pub.pincaimao.com/static/common/i_pcm_logo.png" conversation-id=""
    fullscreen="false"  enable-voice="false" interview-mode="text"
    default-query="请您提问"></pcm-zygh-modal>


  <pcm-video-chat-modal id="pcm-video-chat-modal"
    modal-title="视频面试" icon="https://www.ylzhaopin.com/Public/Newhome/images/sidebar/tochat.png" conversation-id=""
    resume-id="35677279421992960" fullscreen="true" enable-voice="false" total-questions="2"></pcm-video-chat-modal>

  <pcm-hr-chat-modal id="pcm-hr-chat-modal"
    modal-title="金牌HR大赛"
    welcome-message="欢迎您参加长沙市人力资源和社会保障局组织的金牌HR大赛，接下来我们将采用数字人方式对您做交流，本次大赛预计需要10-30分钟，请在安静的环境下参与此次大赛。"
    icon="https://p3-pc.douyinpic.com/img/aweme-avatar/tos-cn-avt-0015_55cc4ce1aa0059074f4f9def520246dc~c5_300x300.jpeg"
    conversation-id="" to-email="790002517@qq.com" user-id="1234567890" display-content-status="true" fullscreen="true"
    require-resume="false" total-questions="2" enable-voice="false"></pcm-hr-chat-modal>

  <script>
    // 定义全局 token 变量，所有组件共享使用
    const SHARED_TOKEN = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJuaWNrbmFtZSI6Ilx1NTMzYlx1ODA1OFx1NzMyYjgxMDMiLCJ1aWQiOjcsImNoYXRfdXNlciI6InBjbS0xMjMiLCJzZWNyZXRfaWQiOiJhay1tTGgwWGxHeVdMMDRjQ041OUdiUVR0MTkiLCJleHAiOjE3NDUzMDc1MzJ9.aYVosy7QE3MvWcwElj11L_41vcXOxc_hDCPVDZWlHxI";

    document.addEventListener('DOMContentLoaded', function () {
      console.log('DOM 已加载，正在设置事件监听器...');
      
      // 设置所有组件的 token 属性
      setComponentTokens();
      
      handleDeviceCheck();
      handleVideoChatModal();
      handleHrChatModal();
      handleMnmsModal();
      handleJlppModal();
      handleZyghModal();
      handleMnctModal();
    });

    // 为所有组件设置共享的 token
    const setComponentTokens = () => {
      const components = [
        'pcm-mnms-modal',
        'pcm-mnct-modal',
        'pcm-jlpp-modal',
        'pcm-zygh-modal',
        'pcm-video-chat-modal',
        'pcm-hr-chat-modal'
      ];
      
      components.forEach(id => {
        const component = document.getElementById(id);
        if (component) {
          component.setAttribute('token', SHARED_TOKEN);
        }
      });
    };

    // 设备检查相关功能
    const handleDeviceCheck = () => {
      const checkDevicesButton = document.getElementById('check-devices');
      const statusMessage = document.getElementById('status-message');
      let stream = null;

      // 辅助函数
      const showError = (message) => {
        statusMessage.textContent = message;
        statusMessage.className = 'status error';
      };

      const showSuccess = (message) => {
        statusMessage.textContent = message;
        statusMessage.className = 'status success';
      };

      // 检查设备和权限
      checkDevicesButton.addEventListener('click', async function () {
        try {
          statusMessage.style.display = 'block';

          // 检查浏览器支持
          if (!navigator.mediaDevices) {
            showError('您的浏览器不支持媒体设备API，请使用现代浏览器如Chrome、Firefox等');
            return;
          }

          // 列出可用的媒体设备
          const devices = await navigator.mediaDevices.enumerateDevices();
          const hasCamera = devices.some(device => device.kind === 'videoinput');
          const hasMicrophone = devices.some(device => device.kind === 'audioinput');

          if (!hasCamera) {
            showError('未检测到摄像头设备');
            return;
          }

          if (!hasMicrophone) {
            showError('未检测到麦克风设备');
            return;
          }

          // 尝试获取媒体流
          stream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true
          });

          // 更新UI状态
          showSuccess('设备和权限检查通过，可以开始聊天');
          document.getElementById('open-chat').disabled = false;
          document.getElementById('open-hr-chat').disabled = false;

        } catch (error) {
          console.error('获取媒体设备失败:', error);

          if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
            showError('权限被拒绝。请在浏览器设置中允许访问摄像头和麦克风。');
          } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
            showError('找不到摄像头或麦克风设备。');
          } else if (error.name === 'NotReadableError' || error.name === 'TrackStartError') {
            showError('无法访问摄像头或麦克风，可能被其他应用程序占用。');
          } else {
            showError(`发生错误: ${error.message}`);
          }
        }
      });

      // 页面关闭时停止所有媒体流
      window.addEventListener('beforeunload', () => {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
      });
    };

    // 视频面试模态框处理
    const handleVideoChatModal = () => {
      const chatModal = document.getElementById('pcm-video-chat-modal');
      const openChatButton = document.getElementById('open-chat');
      
      if (!chatModal || !openChatButton) return;

      // 设置事件监听
      chatModal.addEventListener('messageSent', (event) => {
        console.log('发送消息:', event.detail);
      });

      chatModal.addEventListener('modalClosed', () => {
        console.log('聊天窗口已关闭');
        chatModal.isOpen = false;
      });

      chatModal.addEventListener('streamComplete', (event) => {
        console.log('流式响应完成:', event.detail);
        // 更新 conversation_id
        chatModal.setAttribute('conversation-id', event.detail.conversation_id);
      });

      chatModal.addEventListener('interviewComplete', (event) => {
        console.log('面试完成:', event.detail);
        chatModal.isOpen = false;
      });

      // 打开聊天按钮事件监听
      openChatButton.addEventListener('click', () => {
        chatModal.isOpen = true;
      });
    };

    // 金牌HR大赛模态框处理
    const handleHrChatModal = () => {
      const chatModal = document.getElementById('pcm-hr-chat-modal');
      const openChatButton = document.getElementById('open-hr-chat');
      
      if (!chatModal || !openChatButton) return;

      // 设置事件监听
      chatModal.addEventListener('messageSent', (event) => {
        console.log('发送消息:', event.detail);
      });

      chatModal.addEventListener('modalClosed', () => {
        console.log('聊天窗口已关闭');
        chatModal.isOpen = false;
      });

      chatModal.addEventListener('streamComplete', (event) => {
        console.log('流式响应完成:', event.detail);
        // 更新 conversation_id
        chatModal.setAttribute('conversation-id', event.detail.conversation_id);
      });

      chatModal.addEventListener('interviewComplete', (event) => {
        console.log('面试完成:', event.detail);
        chatModal.isOpen = false;
        alert('非常感谢您的参与，湖南省人力资源协会将会在2024年*月**日公布评选结果，如想获取您在本次金牌大赛中的评选报告，请联系*****，我们将报告发送到您指定邮箱中。');
      });

      // 打开聊天按钮事件监听
      openChatButton.addEventListener('click', () => {
        chatModal.isOpen = true;
      });
    };

    // 模拟面试模态框处理
    const handleMnmsModal = () => {
      const mnmsModal = document.getElementById('pcm-mnms-modal');
      const openChatButton = document.getElementById('open-mnms-chat');
      
      if (!mnmsModal || !openChatButton) return;

      // 设置事件监听
      mnmsModal.addEventListener('modalClosed', () => {
        console.log('聊天窗口已关闭');
        mnmsModal.isOpen = false;
      });

      mnmsModal.addEventListener('streamComplete', (event) => {
        console.log('流式响应完成:', event.detail);
      });

      mnmsModal.addEventListener('interviewComplete', (event) => {
        console.log('面试完成:', event.detail);
        mnmsModal.isOpen = false;
      });

      mnmsModal.addEventListener('uploadSuccess', (event) => {
        console.log('文件上传成功:', event.detail);
      });

      mnmsModal.addEventListener('conversationStart', (event) => {
        console.log('会话开始:', event.detail);
        mnmsModal.setAttribute('conversation-id', event.detail.conversation_id);
      });

      mnmsModal.addEventListener('tokenInvalid', () => {
        console.log('SDK密钥验证失败');
      });

      // 打开聊天按钮事件监听
      openChatButton.addEventListener('click', () => {
        mnmsModal.isOpen = true;
      });

      // 设置自定义输入
      mnmsModal.customInputs = {
        job_info: "对接商家和用户,负责B端活动的策划落地以及C端客户的引流；负责产品的上下架,以及线下活动的开展；负责C端产品的线上线下的引流推广"
      };
    };

    // 面试出题大师模态框处理
    const handleMnctModal = () => {
      const mnctModal = document.getElementById('pcm-mnct-modal');
      const openMnctButton = document.getElementById('open-mnct-chat');
      
      if (!mnctModal || !openMnctButton) return;

      // 设置事件监听
      mnctModal.addEventListener('modalClosed', () => {
        console.log('聊天窗口已关闭');
        mnctModal.isOpen = false;
      });

      mnctModal.addEventListener('streamComplete', (event) => {
        console.log('流式响应完成:', event.detail);
      });

      mnctModal.addEventListener('interviewComplete', (event) => {
        console.log('面试完成:', event.detail);
        mnctModal.isOpen = false;
      });

      mnctModal.addEventListener('uploadSuccess', (event) => {
        console.log('文件上传成功:', event.detail);
      });

      mnctModal.addEventListener('conversationStart', (event) => {
        console.log('会话开始:', event.detail);
        mnctModal.setAttribute('conversation-id', event.detail.conversation_id);
      });

      mnctModal.addEventListener('tokenInvalid', () => {
        console.log('SDK密钥验证失败');
      });

      // 打开聊天按钮事件监听
      openMnctButton.addEventListener('click', () => {
        mnctModal.isOpen = true;
      });

      // 设置自定义输入
      mnctModal.customInputs = {
        job_info: "对接商家和用户,负责B端活动的策划落地以及C端客户的引流；负责产品的上下架,以及线下活动的开展；负责C端产品的线上线下的引流推广"
      };
    };

    // 简历匹配模态框处理
    const handleJlppModal = () => {
      const jlppModal = document.getElementById('pcm-jlpp-modal');
      const openJlpxButton = document.getElementById('open-jlpx-chat');
      
      if (!jlppModal) return;

      // 设置事件监听
      jlppModal.addEventListener('modalClosed', () => {
        console.log('简历评析窗口已关闭');
        jlppModal.isOpen = false;
      });

      jlppModal.addEventListener('streamComplete', (event) => {
        console.log('流式响应完成:', event.detail);
        // 更新 conversation_id
        
      });

      jlppModal.addEventListener('uploadSuccess', (event) => {
        console.log('文件上传成功:', event.detail);
      });

      jlppModal.addEventListener('conversationStart', (event) => {
        console.log('会话开始:', event.detail);
        jlppModal.setAttribute('conversation-id', event.detail.conversation_id);

      });

      // 打开简历评析按钮事件监听
      if (openJlpxButton) {
        openJlpxButton.addEventListener('click', () => {
          jlppModal.isOpen = true;
        });
      }

     
    };

    // 职业规划助手模态框处理
    const handleZyghModal = () => {
      const zyghModal = document.getElementById('pcm-zygh-modal');
      const openZyghButton = document.getElementById('open-zygh-chat');
      
      if (!zyghModal || !openZyghButton) return;

      // 设置事件监听
      zyghModal.addEventListener('modalClosed', () => {
        console.log('职业规划助手窗口已关闭');
        zyghModal.isOpen = false;
      });

      zyghModal.addEventListener('streamComplete', (event) => {
        console.log('流式响应完成:', event.detail);
      });

      zyghModal.addEventListener('uploadSuccess', (event) => {
        console.log('文件上传成功:', event.detail);
      });

      zyghModal.addEventListener('conversationStart', (event) => {
        console.log('会话开始:', event.detail);
        zyghModal.setAttribute('conversation-id', event.detail.conversation_id);

      });

      zyghModal.addEventListener('planningComplete', (event) => {
        console.log('规划完成:', event.detail);
      });

      // 打开职业规划助手按钮事件监听
      openZyghButton.addEventListener('click', () => {
        zyghModal.isOpen = true;
      });

      // 设置自定义输入
      zyghModal.customInputs = {
        type: "转行建议"
      };
    };
  </script>
</body>

</html>